<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document Verification</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #e8e8e8;
        min-height: 100vh;
        padding: 20px;
      }

      .page-header {
        background: #f5f5f5;
        border: 2px solid #333;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
      }

      .page-title {
        font-size: 28px;
        font-weight: bold;
        color: #333;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 5px;
      }

      .page-subtitle {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .comparison-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }

      .document-section {
        flex: 1;
        background: #f5f5f5;
        border: 2px solid #333;
        padding: 20px;
      }

      .section-header {
        background: #333;
        color: white;
        padding: 15px;
        margin: -20px -20px 20px -20px;
        text-align: center;
      }

      .section-title {
        font-size: 18px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .govt-header {
        background: #28a745;
      }

      .user-header {
        background: #007bff;
      }

      .image-container {
        background: white;
        border: 2px solid #333;
        min-height: 450px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .image-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border: 1px solid #ddd;
      }

      .no-image {
        text-align: center;
        color: #666;
        font-size: 16px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .action-section {
        background: #f5f5f5;
        border: 2px solid #333;
        padding: 30px;
        text-align: center;
      }

      .action-header {
        background: #333;
        color: white;
        padding: 15px;
        margin: -30px -30px 20px -30px;
      }

      .action-title {
        font-size: 18px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .user-info {
        background: white;
        border: 2px solid #333;
        padding: 15px;
        margin-bottom: 20px;
        text-align: left;
      }

      .user-info-field {
        margin-bottom: 10px;
      }

      .user-info-label {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 12px;
        color: #333;
        letter-spacing: 1px;
      }

      .user-info-value {
        font-size: 14px;
        color: #666;
        margin-top: 3px;
      }

      .btn {
        background: #333;
        color: white;
        border: 2px solid #333;
        padding: 15px 40px;
        font-size: 16px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        margin: 0 10px;
        transition: all 0.2s ease;
      }

      .btn:hover {
        background: white;
        color: #333;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-approve {
        background: #28a745;
        border-color: #28a745;
      }

      .btn-approve:hover {
        background: white;
        color: #28a745;
      }

      .btn-reject {
        background: #dc3545;
        border-color: #dc3545;
      }

      .btn-reject:hover {
        background: white;
        color: #dc3545;
      }

      .instruction-text {
        margin-bottom: 20px;
        font-size: 14px;
        color: #666;
        text-align: center;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .comparison-container {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          margin: 5px 0;
        }

        .page-title {
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Document Verification</h1>
      <p class="page-subtitle">Government Services Portal - Admin Panel</p>
    </div>

    <!-- Document Comparison Section -->
    <div class="comparison-container">
      <!-- Government Database Document (Left) -->
      <div class="document-section">
        <div class="section-header govt-header">
          <div class="section-title">Government Database</div>
        </div>
        <div class="image-container">
          <% if (govtImage) { %>
          <img src="<%= govtImage %>" alt="Government Database Document" />
          <% } else { %>
          <div class="no-image">
            No Government Record Found<br />
            Check Database Connection
          </div>
          <% } %>
        </div>
      </div>

      <!-- User Submitted Document (Right) -->
      <div class="document-section">
        <div class="section-header user-header">
          <div class="section-title">User Submitted Document</div>
        </div>
        <div class="image-container">
          <% if (userImage) { %>
          <img
            src="/uploads/<%= userImage %>"
            alt="User Submitted Document"
            onerror="this.onerror=null; this.parentElement.innerHTML='<div class=&quot;no-image&quot;>Image File Not Found<br/>Check File Path</div>';"
          />
          <% } else { %>
          <div class="no-image">
            No Document Submitted<br />
            By User
          </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Action Section -->
    <div class="action-section">
      <div class="action-header">
        <div class="action-title">Verification Decision</div>
      </div>

      <div class="instruction-text">
        Compare the documents above and make a verification decision below.
      </div>

      <!-- User Information -->
      <div class="user-info">
        <div class="user-info-field">
          <div class="user-info-label">Applicant Name</div>
          <div class="user-info-value">
            <%= user?.firstName || 'N/A' %> <%= user?.lastName || '' %>
          </div>
        </div>
        <div class="user-info-field">
          <div class="user-info-label">User ID / Ping ID</div>
          <div class="user-info-value">
            <%= user?.pingId || user?.userId || user?._id || 'N/A' %>
          </div>
        </div>
        <div class="user-info-field">
          <div class="user-info-label">Document Type</div>
          <div class="user-info-value">Voter Identity Card</div>
        </div>
        <div class="user-info-field">
          <div class="user-info-label">Verification Date</div>
          <div class="user-info-value">
            <%= new Date().toLocaleDateString() %>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="buttons-container">
        <button class="btn btn-approve" onclick="handleApproval(true)">
          ✓ Approve Application
        </button>
        <button class="btn btn-reject" onclick="handleApproval(false)">
          ✗ Reject Application
        </button>
      </div>
    </div>

    <script>
      // Debug image loading
      console.log("User image path: <%= userImage || 'null' %>");
      console.log("Government image path: <%= govtImage || 'null' %>");

      function handleApproval(isApproved) {
        const action = isApproved ? "approve" : "reject";
        const button = event.target;
        const originalText = button.innerHTML;

        // Show loading state
        button.innerHTML = isApproved ? "APPROVING..." : "REJECTING...";
        button.disabled = true;

        // Get data from the page
        const userId = '<%= user?.pingId || "" %>';
        const documentId = '<%= documentId || "" %>';

        // Make API call
        fetch(`/admin/document-verification/${action}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            userId: userId,
            documentId: documentId,
            action: action,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              button.innerHTML = isApproved ? "✓ APPROVED!" : "✗ REJECTED!";
              setTimeout(() => {
                window.location.href = "/admin/applications";
              }, 1500);
            } else {
              throw new Error(data.message || "Operation failed");
            }
          })
          .catch((error) => {
            alert("Error: " + error.message);
            button.innerHTML = originalText;
            button.disabled = false;
          });
      }

      // Add keyboard shortcuts
      document.addEventListener("keydown", function (event) {
        if (event.key === "a" || event.key === "A") {
          handleApproval(true);
        } else if (event.key === "r" || event.key === "R") {
          handleApproval(false);
        }
      });

      // Test image accessibility on page load
      document.addEventListener("DOMContentLoaded", function () {
        const userImage = '<%= userImage || "" %>';
        if (userImage) {
          const testImg = new Image();
          testImg.onload = function () {
            console.log("✓ User image loaded successfully:", userImage);
          };
          testImg.onerror = function () {
            console.error("✗ User image failed to load:", userImage);
            console.log("Full URL:", `/uploads/${userImage}`);
          };
          testImg.src = `/uploads/${userImage}`;
        }
      });
    </script>
  </body>
</html>
